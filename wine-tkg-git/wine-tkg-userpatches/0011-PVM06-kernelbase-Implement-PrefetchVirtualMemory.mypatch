From: Jinoh Kang <jinoh.kang.kr@gmail.com>
Subject: [PATCH 6/6] kernelbase: Implement PrefetchVirtualMemory.
Message-Id: <d3471266-7666-0cc0-7240-a0c980438db2@gmail.com>
Date: Thu, 20 Jan 2022 02:29:31 +0900
In-Reply-To: <d8105173-f9a2-317e-1c27-ddd290627f7a@gmail.com>
References: <d8105173-f9a2-317e-1c27-ddd290627f7a@gmail.com>

Signed-off-by: Jinoh Kang <jinoh.kang.kr@gmail.com>
---
 dlls/kernel32/tests/virtual.c | 1 -
 dlls/kernelbase/memory.c      | 9 +++++----
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/dlls/kernel32/tests/virtual.c b/dlls/kernel32/tests/virtual.c
index 11111111111..11111111111 100644
--- a/dlls/kernel32/tests/virtual.c
+++ b/dlls/kernel32/tests/virtual.c
@@ -4484,7 +4484,6 @@ static void test_PrefetchVirtualMemory(void)
         return;
     }
 
-    todo_wine
     ok( !pPrefetchVirtualMemory( GetCurrentProcess(), 0, NULL, 0 ),
         "PrefetchVirtualMemory unexpected success on 0 entries\n" );
 
diff --git a/dlls/kernelbase/memory.c b/dlls/kernelbase/memory.c
index 11111111111..11111111111 100644
--- a/dlls/kernelbase/memory.c
+++ b/dlls/kernelbase/memory.c
@@ -365,11 +365,12 @@ LPVOID WINAPI DECLSPEC_HOTPATCH VirtualAllocFromApp( void *addr, SIZE_T size,
 /***********************************************************************
  *             PrefetchVirtualMemory   (kernelbase.@)
  */
-BOOL WINAPI /* DECLSPEC_HOTPATCH */ PrefetchVirtualMemory( HANDLE process, ULONG_PTR count,
-                                                           WIN32_MEMORY_RANGE_ENTRY *addresses, ULONG flags )
+BOOL WINAPI DECLSPEC_HOTPATCH PrefetchVirtualMemory( HANDLE process, ULONG_PTR count,
+                                                     WIN32_MEMORY_RANGE_ENTRY *addresses, ULONG flags )
 {
-    FIXME( "process %p, count %p, addresses %p, flags %#lx stub.\n", process, (void *)count, addresses, flags );
-    return TRUE;
+    return set_ntstatus( NtSetInformationVirtualMemory( process, VmPrefetchInformation,
+                                                        count, (PMEMORY_RANGE_ENTRY)addresses,
+                                                        &flags, sizeof(flags) ));
 }
 
 

-- 
2.36.0

